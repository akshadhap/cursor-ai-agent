chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"spinabot-ask-ai",title:"Ask Spinabot AI",contexts:["selection"]}),console.log("Spinabot AI Assistant V2 installed!")});chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(console.log("Context menu clicked:",e),e.menuItemId==="spinabot-ask-ai"&&(t!=null&&t.id)){console.log("Opening Spinabot panel for tab:",t.id);try{await i(t.id,{type:"SHOW_AI_MENU",text:e.selectionText}),console.log("Panel opened successfully")}catch(o){console.warn("Message failed, attempting to inject script...",o);try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),await chrome.scripting.insertCSS({target:{tabId:t.id},files:["content.css"]}),console.log("Script injected, retrying message..."),await new Promise(n=>setTimeout(n,100)),await i(t.id,{type:"SHOW_AI_MENU",text:e.selectionText}),console.log("Panel opened successfully after injection")}catch(n){console.error("Failed to recover:",n)}}}});chrome.action.onClicked.addListener(async e=>{if(console.log("Extension icon clicked for tab:",e.id),e!=null&&e.id)try{await i(e.id,{type:"TOGGLE_SIDE_PANEL"}),console.log("Panel toggled successfully")}catch(t){console.warn("Message failed, attempting to inject script...",t);try{await chrome.scripting.executeScript({target:{tabId:e.id},files:["content.js"]}),await chrome.scripting.insertCSS({target:{tabId:e.id},files:["content.css"]}),console.log("Script injected, retrying message..."),await new Promise(o=>setTimeout(o,100)),await i(e.id,{type:"TOGGLE_SIDE_PANEL"}),console.log("Panel toggled successfully after injection")}catch(o){console.error("Failed to recover:",o)}}});function i(e,t){return new Promise((o,n)=>{chrome.tabs.sendMessage(e,t,r=>{chrome.runtime.lastError?n(chrome.runtime.lastError):o(r)})})}chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="API_REQUEST")return d(e.payload).then(n=>o({success:!0,data:n})).catch(n=>o({success:!1,error:n.message})),!0});async function d(e){const t="http://localhost:3000",{action:o,text:n,options:r={}}=e,c=`${t}/api/agent/${o}`;console.log(`[Spinabot] Making API request to: ${c}`),console.log("[Spinabot] Payload:",{text:n.substring(0,100)+"...",...r});try{const s=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,...r})});if(console.log(`[Spinabot] Response status: ${s.status}`),!s.ok){const l=await s.text();throw console.error("[Spinabot] API error:",l),new Error(`API request failed: ${s.statusText}`)}const a=await s.json();return console.log("[Spinabot] Response data:",a),a}catch(s){throw console.error("[Spinabot] API request error:",s),s.message.includes("fetch")?new Error("Cannot connect to server. Make sure the web app is running on http://localhost:3000"):s}}
